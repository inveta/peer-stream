<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
        body {
            height: 100vh;
            width: 100vw;
            font-size: 16px;
            margin: 0;
            background-color: #2e303e;
        }
        input[type="checkbox"] {
            appearance: none;
            width: 4rem;
            height: 2rem;
            position: relative;
            border-radius: 1.25rem;
            cursor: pointer;
            background-color: white;
            border: 0.125rem solid #dddddd;
        }
        input[type="checkbox"]:before {
            content: "";
            position: absolute;
            width: 1.625rem;
            height: 1.625rem;
            background: #dddddd;
            left: 0.125rem;
            top: 0.0625rem;
            border-radius: 50%;
            transition: left cubic-bezier(0.3, 1.5, 0.7, 1) 0.3s;
        }
        input[type="checkbox"]:after {
            content: "";
            text-indent: 0.75px;
            word-spacing: 0.25px;
            display: inline-block;
            white-space: nowrap;
            color: white;
        }
        input[type="checkbox"]:checked {
            border-color: #8ce196;
        }
        input[type="checkbox"]:checked:before {
            left: 32px;
            background: #8ce196;
        }
        .main {
            width: 100%;
            height: 100%;
        }        
        .header {
            width: 100%;
            height: 5vh;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 2;
            background-color: black;
            box-shadow: 0 0 0.2rem #0000001a, 0 0.2rem 0.4rem #0003;        
            display: flex;
            color: white;
            @media screen and (min-width: 768px) and (orientation: landscape){
                display: none;
            }
        }
        #toggleSidebar {
            height: 100%;
            aspect-ratio: 1;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .title {
            width: 50%;
            font-size: 1rem;
            margin: 0 6vw;
            display: flex;
            justify-content: left;
            align-items: center;
        }
        #config-form {
            margin: 3vh auto 0;
            color: white;
            font-size: 1rem;
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            @media screen and (min-width: 768px) and (orientation: landscape) {
                width: 77%;
                margin: 5vh 0 0 16.5%;
                height: 98%;
            }
        }        
        .item {
            margin: 2vh 0;
            display: flex;
            align-items: center;
            height: 2rem;
            width: 100%;
        }
        .item label {
            width: 7rem;
            @media screen and (min-width: 768px) {
                text-align: right;
            }
        }
        .common-input,.auth-input {
            position: relative;
            @media screen and (min-width: 1200px) {
                width: 33%;
            }
        }
        .common-input input,.auth-input input {
            margin-left: 0.5rem;
            width: calc(100% - 7rem);
            height: 60%;
        }
        .common-input {
            flex: 33.3%;
        }
        .auth-input {
            flex: 50%;
        }
        #password-icon {
            position: absolute;
            right: 2%;
            color: black;
        }
        .switch-input {
            @media screen and (min-width: 768px) {
                flex: 33.3%;
            }
            @media screen and (min-width: 1200px) {
                flex: none;
                width: auto;
            }
        }
        .switch-input input {
            margin-left: 0.5rem;
        }
        .exec-title {
            display: flex;
            align-items: center;
            height: 2rem;
            margin: 2vh 0;
        }
        .exec-title span {
            @media screen and (min-width: 768px) {
                width: 7rem;
                text-align: right;
            }
        }
        .form-btn {
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #9496b1;
        }
        .exec-btn {
            width: 1.5rem;
            height: 1.5rem;
            margin-left: 0.5rem;
        }
        #exec-container {
            flex: 100%;
        }
        .exec span {
            width: 7rem;
            @media screen and (min-width: 768px) {
                text-align: right;
            }
        }
        .exec input {
            height: 60%;
            margin-left: 0.5rem;
            width: calc(100% - 9rem)
        }
        #iceServers-container {
            display: flex;
            flex-direction: row;
            margin: 0.5rem 0;
            flex: 100%;
        }
        #iceServers-container span {
            width: 7rem;
            margin: 1vh 0;
            @media screen and (min-width: 768px){
                text-align: right;
            }
        }
        #iceServers-container textarea {
            width: 100%;
            height: 5rem;
            margin-left: 0.5rem;
            @media screen and (min-width: 768px) {
                height: 10rem;
                width: calc(100% - 6rem);
            }
        }
        #submitBtn {
            height: 2rem;
            width: 8rem;
            margin: auto;
            margin-top: 1rem;
        }
        .sidebar {
            position: absolute;
            top: 5vh;
            left: -60%;
            width: 60%;
            height: 95vh;
            z-index: 4;
            background-color: black;
            color: white;
            font-size: 1rem;
            /* transition: left cubic-bezier(0.3, 1, 0.7, 1) 0.3s; */
            @media screen and (min-width: 768px) and (orientation: landscape){
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                width: 15%;
                font-size: 1rem;
            }
        }

        .sidebarBtn-container {
            margin-top: 5vh;
        }
        .sidebarBtn {
            height: 6vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* border-bottom: 0.125rem solid white; */
        }
        .btn:hover {
            cursor: pointer;
        }
        #runningServers-container {
            overflow: hidden;
            display: flex;
            width: 100%;
            height: 100%;
            @media screen and (min-width: 768px) and (orientation: landscape) {
                width: 82%;
                margin-left: 16.5%;
            }
        }

        video {
			width: 100%;
            height: 100%;
            margin-top: 1.5rem;
		}

		#stats {
            position: absolute;
			pointer-events: none;
			text-shadow: black 0 0 0.3em;
            font-size: 0.8rem;
		}
    </style>
</head>

<body>
    <script type="text/javascript" src="./peer-stream.js"></script>

    <div class="sidebar">
        <div class="sidebarBtn-container">
            <div class="sidebarBtn btn" id="restartSignal">重启 signal.js</div>
            <div class="sidebarBtn btn" id="downloadSignal">下载 signal.json</div>
            <div class="sidebarBtn btn" id="rebootWindow">重启电脑</div>
            <div class="sidebarBtn btn" id="linktoPS">访问仓库</div>
            <div class="sidebarBtn btn" id="linkToUpdateConfig">服务配置</div>
            <div class="sidebarBtn btn" id="linkToRunningServer">视频监控</div>
        </div>
    </div>
    <div class="header">
            <div id="toggleSidebar">▶️</div>
            <div class="title">服务配置</div>
    </div>
    <div class="content router-view">router-view</div>

    <script type="text/javascript">
        function template(strings, ...keys) {
            return (...values) => {
                const dict = values[values.length - 1] || {};
                const result = [strings[0]];
                keys.forEach((key, i) => {
                    const value = Number.isInteger(key) ? values[key] : dict[key];
                    result.push(value, strings[i + 1]);
                });
                return result.join("");
            };
        }
        const execTemp = template`
            <div class="exec item">
                <span>启动项</span>
                <input id="exec_${"execNum"}" name="UE5" value="${"value"}"/>
                <div class="form-btn exec-btn btn" name="deleteBtn">✖️</div>
            </div>
        `;
        const updateConfig = `<div id="config-form">
                            <div class="item common-input">
                                <label for="PORT">
                                    <span>端口</span>
                                </label>
                                <input type="number" id="PORT" name="PORT" required />
                            </div>
                            <div class="item common-input">
                                <label for="preload">
                                    <span>预加载个数</span>
                                </label>
                                <input type="number" name="preload" id="preload" required/>
                            </div>
                            <div class="item common-input">
                                <label for="exeUeCoolTime">
                                    <span>冷却时间 (s) </span>
                                </label>
                                <input type="number" name="exeUeCoolTime" id="exeUeCoolTime" required>
                            </div>

                            <div class="item auth-input">
                                <label for="username">
                                    <span>用户名</span>
                                </label>
                                <input type="text" id="username" name="username" required />
                            </div>
                            <div class="item auth-input">
                                <label for="password">
                                    <span>密码</span>
                                </label>
                                <input type="password" name="password" id="password" required />
                                <div id="password-icon">👁</div>
                            </div>
                            <div class="item switch-input">
                                <label for="one2one">
                                    <span>一对一模式</span>
                                </label>
                                <input type="checkbox" id="one2one" name="one2one" />
                            </div>
                            <div class="item switch-input">
                                <label for="boot">
                                    <span>开机自启动</span>
                                </label>
                                <input type="checkbox" id="boot" name="boot" />
                            </div>
                            <div class="item switch-input">
                                <label for="UEVersion">
                                    <span>兼容 UE4</span>
                                </label>
                                <input type="checkbox" id="UEVersion" name="UEVersion" />
                            </div>
                        <div id="exec-container">
                            <div class="exec-title">
                                <span>UE5</span>
                                <div id="addExec" class="form-btn exec-btn btn">+</div>
                            </div>
                        </div>
                        <div id="iceServers-container">
                            <span>iceServers</span>
                            <textarea id="iceServers" name="iceServers"></textarea>                  
                        </div> 
                        <div id="submitBtn" class="form-btn btn">更新 signal.json</div>
                </div>`;
        const runningServer = `
            <div id="runningServers-container">
                <video is="peer-stream" id="ws://10.0.42.16:88" audio> </video>

	            <!-- WebRTC monitor -->
	            <pre id="stats">Not connected</pre>    
            </div>
        `;
        //页面初始化   
        document
            .querySelector("#restartSignal")
            .addEventListener("click", async () => {
                try {
                    const res = await fetch("./restartSignal");
                } catch (error) {
                    console.log("restartSignal failed", error);
                }
            });
        document
            .querySelector("#downloadSignal")
            .addEventListener("click", () => {
                window.open("./signal.json");
            });
        document
            .querySelector("#rebootWindow")
            .addEventListener("click", async () => {
                try {
                    const res = await fetch("./rebootWindow");
                } catch (error) {
                    console.log("rebootWindow failed", error);
                }
            });
        document
            .querySelector("#linktoPS")
            .addEventListener("click", () => {
                window.open("https://github.com/inveta/peer-stream")
            })
        document
            .querySelector("#toggleSidebar")
            .addEventListener("click", () => {
                toggleSidebar();
            })
        document
            .querySelector("#linkToUpdateConfig")
            .addEventListener("click", () => {
                window.open("#/updateConfig", "_self");
            })
        document
            .querySelector("#linkToRunningServer")
            .addEventListener("click", () => {
                window.open("#/runningServer", "_self");
            })

        //渲染页面主内容
        const renderPageContent = (pageHash) => {
            const rv = document.querySelector(".router-view");
            switch (pageHash) {
                case "/updateConfig": {
                    fetch("./signal.json")
                        .then((res) => {
                            rv.innerHTML = updateConfig;
                            return res.json();
                        })
                        .then((data) => {
                            initConfig(data);
                            document
                                .querySelector("#addExec")
                                .addEventListener("click", addExec);
                            document.querySelectorAll("[name = deleteBtn]").forEach((obj) => {
                                obj.addEventListener("click", () => {
                                    deleteExec(obj);
                                });
                            });
                            document
                                .querySelector("#submitBtn")
                                .addEventListener("click", () => {
                                    submitConfig(event);
                                });
                            document
                                .querySelector("#password-icon")
                                .addEventListener("click", togglePassword);
                            if(typeof ps !== "undefined")
                                window.clearTimeout(ps.timeout)                           
                        });
                    break;
                }
                case "/runningServer": {
                    rv.innerHTML = runningServer;
                    ps.addEventListener("playing", aggregateStats, { once: true });
                    ps.addEventListener("message", (e) => { });
                    ps.addEventListener("suspend", (e) => { });
                    ps.addEventListener("playerdisconnected", (e) => {
                        console.log("playerdisconnected");
                    });
                    break;
                }
                if(window.screen.orientation.type ===  "portrait-primary"){
                    toggleSidebar();
                }
            }
        };
        const toggleSidebar = () => {
            const sidebar = document.querySelector(".sidebar")
            sidebar.style.left = (sidebar.style.left === "0px"? "-60%" : "0px")
        }
        //增加一个启动项
        const addExec = () => {
            const exec_container = document.querySelector("#exec-container");
            const execNum = document.querySelectorAll(".exec").length;
            const exec = str2dom(execTemp({ execNum: execNum, value: "" })).querySelector(".exec")
            exec.querySelector("[name=deleteBtn]").addEventListener("click", function () {
                exec_container.removeChild(exec)
            });
            exec_container.appendChild(exec);
        };
        //启动项删除
        const deleteExec = (obj) => {
            const exec_container = document.querySelector("#exec-container");
            console.log(obj);
            console.log(obj.parentNode)
            exec_container.removeChild(obj.parentNode);
        };
        //密码显示或者隐藏
        const togglePassword = () => {
            if (document.querySelector("#password").type === "password") {
                document.querySelector("#password-icon").style.textDecoration =
                    "line-through";
                document.querySelector("#password").type = "text";
            } else {
                document.querySelector("#password-icon").style.textDecoration =
                    "none";
                document.querySelector("#password").type = "password";
            }
        };
        //字符串转dom
        const str2dom = (obj) => {
            return new DOMParser().parseFromString(obj, 'text/html')
        }
        //字符串转布尔
        const str2Boolean = (obj) => {
            return obj.toLowerCase() === "true" ? true : false;
        };
        const initConfig = (data) => {
            for (key in data) {
                switch (key) {
                    case "env":
                    case "throttle":
                        break;
                    case "UE5":
                        let execNum = 0;
                        const execContainer = document.querySelector("#exec-container")
                        data[key].forEach((exec) => {
                            const execItem = str2dom(execTemp({ execNum: execNum++, value: exec })).querySelector(".exec")
                            execContainer.appendChild(execItem);
                        })
                        break;
                    case "iceServers":
                        const iceServers = document.querySelector("[name = iceServers]");
                        iceServers.value = JSON.stringify(data[key], null, '\t');
                        break;
                    case "auth":
                        const [username, password] = data[key].split(":");
                        document.querySelector("[name=username]").value = username;
                        document.querySelector("[name=password]").value = password;
                        break;
                    case "UEVersion":
                        document.querySelector("[name = UEVersion]").checked = (data[key] === 4.27 ? true : false);
                        break;
                    default:
                        const item = document.querySelector("[name=" + key + "]");
                        if (item.type === "checkbox") {
                            item.checked = data[key];
                            break;
                        }
                        item.value = data[key];
                        break;
                }
            }
        }
        //处理获取到的配置并提交
        const submitConfig = async () => {
            try {
                event.preventDefault();
                const config = {
                    PORT: null,
                    username: null,
                    password: null,
                    one2one: null,
                    preload: null,
                    exeUeCoolTime: null,
                    UEVersion: null,
                    boot: null,
                    UE5: [],
                    iceServers: null,
                };
                for (key in config) {
                    const item = document.querySelectorAll("[name=" + key + "]");
                    item.forEach((element) => {
                        switch (element.type) {
                            case "number":
                                config[key] = parseFloat(element.value);
                                break;
                            case "checkbox":
                                config[key] = key === "UEVersion" ? (element.checked ? 4.27 : 5) : element.checked;
                                break;
                            default:
                                if (element.name === "UE5") {
                                    config[key].push(element.value);
                                    break;
                                } 
                                config[key] = (element.name === "iceServers" ? JSON.parse(element.value) : element.value)
                        }
                    });
                }
                config.auth = `${config.username}:${config.password}`;
                delete config.username;
                delete config.password;
                const res = await fetch("./updateConfig", {
                    method: "POST",
                    headers: {
                        "Content-type": "application/json",
                    },
                    body: JSON.stringify(config),
                });
            } catch (error) {
                console.log("updateConfig failed", error);
            }
        };

        const aggregateStats = async () => {
            const statsReport = await ps.pc.getStats(null);
            stats.innerText = "";

            // most < 27
            if (ps.VideoEncoderQP < 27) {
                stats.style.color = "lime";
            } else if (ps.VideoEncoderQP < 36) {
                stats.style.color = "orange";
                stats.innerText += `\n Spotty Network !`;
            } else {
                stats.style.color = "red";
                stats.innerText += `\n Bad Network !!`;
            }

            stats.innerText += `\n Video Quantization Parameter: ${ps.VideoEncoderQP}`;
            statsReport.forEach((stat) => {
                switch (stat.type) {
                    case "data-channel": {
                        stats.innerText += `\n ✉ Data Channel ↑↑ ${stat.bytesSent.toLocaleString()} B`;
                        stats.innerText += `\n ✉ Data Channel ↓↓ ${stat.bytesReceived.toLocaleString()} B`;
                        break;
                    }
                    case "inbound-rtp": {
                        if (stat.mediaType === "video")
                            stats.innerText += [
                                ``,
                                `	Size: ${stat.frameWidth} x ${stat.frameHeight}`,
                                `	Frames Decoded: ${stat.framesDecoded.toLocaleString()}`,
                                `	Packets Lost: ${stat.packetsLost.toLocaleString()}`,
                                `	FPS: ${stat.framesPerSecond} Hz`,
                                `	Frames Dropped: ${stat.framesDropped}`,
                                `	Video ↓↓ ${stat.bytesReceived.toLocaleString()} B`,
                            ].join("\n");
                        else if (stat.mediaType === "audio")
                            stats.innerText += `\n ♬ Audio ↓↓ ${stat.bytesReceived.toLocaleString()} B`;
                        break;
                    }
                    case "candidate-pair": {
                        if (stat.state === "succeeded")
                            stats.innerText += `\n Latency(RTT): ${stat.currentRoundTripTime} s`;
                        break;
                    }
                    case "remote-candidate": {
                        stats.innerText +=
                            `\n ` + stat.protocol + ":// " + stat.ip + ": " + stat.port;
                        break;
                    }
                    case "transport": {
                        const bitrate = ~~(
                            ((stat.bytesReceived - this.bytesReceived) /
                                (stat.timestamp - this.timestamp)) *
                            (1000 * 8)
                        );

                        stats.innerText += `\n ⇌ Bitrate: ${bitrate.toLocaleString()} bps`;

                        this.bytesReceived = stat.bytesReceived;
                        this.timestamp = stat.timestamp;
                        break;
                    }
                    default: {
                    }
                }
            });

            stats.innerText += `\n ⏲ Current Time: ${ps.currentTime} s`;

            ps.timeout = setTimeout(aggregateStats, 1000);
        }
        function navigateBasedOnHash() {
            const pageHash = window.location.hash.slice(1) || "/";
            pageHash === '/'? window.location.hash = "/updateConfig" : renderPageContent(pageHash)   
        }
        // 页面加载和变化事件
        window.onload = navigateBasedOnHash;
        window.onhashchange = navigateBasedOnHash;

    </script>
</body>

</html>