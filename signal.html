<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --main-bg-color-dark: #000000;
      --font-color-dark: #ffffff;
      --sidabar-bg-color-dark: #708090;
      --btn-color-dark: #8ce196;
      --btn-hover-bg-color-dark: #dddddd;
      --btn-font-color-dark: #000000;
    }

    html {
      font-size: calc(14px + (100vw - 480px) * (3 / 720));

      @media (max-width: 480px) {
        font-size: 14px;
      }

      @media (min-width: 1200px) {
        font-size: 16px;
      }
    }

    html::-webkit-scrollbar {
      display: none;
    }

    body {
      height: 100vh;
      width: 100vw;
      margin: 0;
      background-color: var(--main-bg-color-dark);
    }

    input[type="checkbox"] {
      appearance: none;
      width: 4rem;
      height: 2rem;
      position: relative;
      border-radius: 1rem;
      cursor: pointer;
      background-color: white;
      border: 0.125rem solid #dddddd;
    }

    input[type="checkbox"]:before {
      content: "";
      position: absolute;
      width: 1.6rem;
      height: 1.6rem;
      background: #dddddd;
      left: 0.15rem;
      top: 0.075rem;
      border-radius: 50%;
      transition: left cubic-bezier(0.3, 1.5, 0.7, 1) 0.3s;
    }

    input[type="checkbox"]:checked {
      border-color: #8ce196;
    }

    input[type="checkbox"]:checked:before {
      left: 2rem;
      background: #8ce196;
    }

    #configForm {
      margin: 0 0 0 3rem;
      height: 98%;
      color: var(--font-color-dark);
      font-size: 1rem;
      display: flex;
      flex-wrap: wrap;

      @media screen and (min-width: 768px) {
        margin-left: 11rem;
      }
    }

    input,
    textarea {
      color: var(--font-color-dark);
      background-color: var(--main-bg-color-dark);
      border: 1px solid var(--sidabar-bg-color-dark);
      border-radius: 0.5rem;
    }

    .item {
      margin: 0.5rem 0;
      display: flex;
      flex-direction: column;
      width: 100%;
      position: relative;
    }

    .common-input,
    .auth-input {
      margin: 0.5rem 3%;
      width: 44%;

      @media screen and (min-width: 1200px) {
        margin: 0.5rem 1%;
        width: 48%;
      }
    }

    .common-input input,
    .auth-input input {
      width: auto;
      margin: 0.4rem 0;
      height: 1.6rem;
      font-size: 1.2rem;
    }

    .switch-input {
      align-items: center;
      width: calc(100% / 2);
      display: flex;
      flex-direction: column;

      @media screen and (min-width: 425px) {
        width: calc(100% / 4);
      }

      @media screen and (min-width: 1200px) {
        margin: 0.5rem 0.75%;
        width: 11%;
      }
    }

    .switch-input input {
      margin: 0.5rem 0 0 0;
    }

    #exec-container {
      width: 100%;
    }

    .exec-title {
      align-items: center;
      margin: 0.5rem 3% 0;

      @media screen and (min-width: 1200px) {
        height: 2rem;
        margin: 0.5rem 1% 0;
      }
    }

    #exec-input {
      display: flex;
      flex-wrap: wrap;
    }

    .textarea-container {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .textarea-container span {
      margin: 0.5rem 3%;

      @media screen and (min-width: 1200px) {
        margin: 0.5rem 1%;
      }
    }

    .textarea-container textarea {
      height: 10rem;
      margin: 0.5rem 3%;

      @media screen and (min-width: 1200px) {
        margin: 0.5rem 1%;
      }
    }

    .form-btn {
      border-radius: 0.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--btn-color-dark);
    }

    .form-btn:hover {
      background-color: var(--btn-hover-bg-color-dark);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 3rem;
      font-size: 1rem;
      z-index: 4;
      color: var(--btn-font-color-dark);

      @media screen and (min-width: 768px) {
        width: 11rem;
      }
    }

    .sidebarBtn {
      height: 64px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--sidabar-bg-color-dark);
      text-decoration: none;
      color: black;

      @media screen and (min-width: 768px) {
        padding-left: 1rem;
        justify-content: left;
      }
    }

    .sidebarBtn::before {
      filter: sepia(100%) hue-rotate(184deg) saturate(500%);
      content: attr(data-mini);
    }

    @media screen and (min-width: 768px) {
      .sidebarBtn::before {
        content: attr(data-normal);
      }
    }

    .highlighted {
      background-color: var(--main-bg-color-dark);
      color: var(--font-color-dark);
    }

    .fill {
      background-color: var(--sidabar-bg-color-dark);
      flex: 100%;
      height: 100%;
    }

    :has(+ .highlighted) {
      border-bottom-right-radius: 1rem;
    }

    .highlighted+* {
      border-top-right-radius: 1rem;
    }

    .btn:hover {
      cursor: pointer;
    }

    #runningServers-container {
      display: flex;
      height: 100%;
      margin-left: 3rem;

      @media screen and (min-width: 768px) {
        margin-left: 11rem;
      }
    }

    video {
      overflow: hidden;
      height: calc(100vh - 2rem);
      width: 100%;
      margin: 1rem;
    }

    #stats {
      position: absolute;
      pointer-events: none;
      margin: 1rem;
      text-shadow: var(--btn-color-dark) 0 0 0.3em;
      font-size: 1rem;
      color: var(--font-color-dark);
    }
  </style>
</head>

<body>
  <script type="text/javascript" src="./peer-stream.js"></script>

  <aside class="sidebar">
    <a class="sidebarBtn btn" href="./signal.json" target="_blank" download="signal.json" data-normal="â¬‡ï¸ ä¸‹è½½ signal.json" data-mini="â¬‡ï¸"
      aria-label="ä¸‹è½½ signal.json"></a>
    <rebootWindow class="sidebarBtn btn" data-normal="ğŸ”„ é‡å¯ç”µè„‘" data-mini="ğŸ”„"></rebootWindow>
    <a class="sidebarBtn btn" href="#/updateConfig" data-normal="âš™ï¸ signal.json" data-mini="âš™ï¸" aria-label="signal.json"
      name="linkToConfig"></a>
    <a class="sidebarBtn btn" href=" " data-normal="ğŸ¥ è§†é¢‘ç›‘æ§" data-mini="ğŸ¥" aria-label="è§†é¢‘ç›‘æ§" name="linkToServer"></a>
    <a class="sidebarBtn btn" href="https://github.com/inveta/peer-stream" target="_blank" rel="noopener"
      data-normal="ğŸ“¦ Github æºç " data-mini="ğŸ“¦" aria-label="Github æºç "></a>
    <div class="fill"></div>
  </aside>
  <main class="content router-view">router-view</main>

  <script type="text/javascript">
    //å­—ç¬¦ä¸²è½¬dom
    const str2dom = (obj) => {
      return new DOMParser().parseFromString(obj, "text/html");
    };
    //å­—ç¬¦ä¸²è½¬å¸ƒå°”
    const str2Boolean = (obj) => {
      return obj.toLowerCase() === "true" ? true : false;
    };
    const canBeParsed = (str) => {
      try {
        JSON.parse(str);
        return true;
      } catch (error) {
        return false;
      }
    };

    const template = (strings, ...keys) => {
      return (...values) => {
        const dict = values[values.length - 1] || {};
        const result = [strings[0]];
        keys.forEach((key, i) => {
          const value = Number.isInteger(key) ? values[key] : dict[key];
          result.push(value, strings[i + 1]);
        });
        return result.join("");
      };
    };
    const execTemp = template`
        <div class="common-input item exec">
          <span>GPU ${"graphicsAdapter"} è¿›ç¨‹ä¸ªæ•°</span>
          <input name="processNumber" id="${"graphicsAdapter"}" type="number" value="${"GPUNumber"}" placeholder="è¯·è¾“å…¥éœ€è¦çš„è¿›ç¨‹ä¸ªæ•°"/>
        </div>
      `;
    const updateConfig = `
        <form id="configForm">
          <div class="item auth-input">
            <label for="auth">ç”¨æˆ·éªŒè¯</label>
            <input type="password" id="auth" name="auth" pattern="/^[a-zA-Z0-9]+:[a-zA-Z0-9]+$/" />
          </div>
          <div class="item common-input">
            <label for="PORT">ç«¯å£</label>
            <input type="number" id="PORT" name="PORT" required />
          </div>
          <div class="item common-input">
            <label for="preload">é¢„åŠ è½½ä¸ªæ•°</label>
            <input type="number" name="preload" id="preload" required />
          </div>
          <div class="item common-input">
            <label for="exeUeCoolTime">å†·å´æ—¶é—´ (s) </label>
            <input type="number" name="exeUeCoolTime" id="exeUeCoolTime" required>
          </div>
          <div class="item switch-input">
            <label for="auth">http è®¤è¯</label>
            <input type="checkbox" id="http-auth" name="http-auth" />
          </div>
          <div class="item switch-input">
            <label for="one2one">ä¸€å¯¹ä¸€æ¨¡å¼</label>
            <input type="checkbox" id="one2one" name="one2one" />
          </div>
          <div class="item switch-input">
            <label for="boot">
              <span>å¼€æœºè‡ªå¯åŠ¨</span>
            </label>
            <input type="checkbox" id="boot" name="boot" />
          </div>
          <div class="item switch-input">
            <label for="UEVersion">
              <span>æ—§ç‰ˆ UE4</span>
            </label>
            <input type="checkbox" id="UEVersion" name="UEVersion" />
          </div>
          <div id="exec-container">
            <div class="exec-title">UE5</div>
            <div id="exec-input">
              <div class="item common-input">
                <span>UEå¯åŠ¨è¿›ç¨‹</span>
                <input type="text" name="GPUFile" id="GPUFile" placeholder="å¡«å…¥GPUæœåŠ¡å™¨ä¸­çš„æ–‡ä»¶(éœ€è¦å¡«å…¥ç»å¯¹åœ°å€)" />
              </div>
              <div class="item common-input">
                <span>WebSocketåœ°å€</span>
                <input type="text" name="pixelStreamingURL" id="pixelStreamingURL"
                  placeholder="å¡«å…¥é“¾æ¥signal.jsçš„WebSocketåœ°å€" />
              </div>
              <div class="item common-input">
                <span>åˆ†è¾¨ç‡</span>
                <input name="resolution" list="resolutionList" id="resolution"
                  placeholder="å¡«å…¥æ‰€éœ€åˆ†è¾¨ç‡(è¯·ä½¿ç”¨æ ‡å‡†åˆ†è¾¨ç‡æ ¼å¼ï¼Œå¦‚ï¼š1920*1080)" />
                <datalist id="resolutionList">
                  <option value="1920*1080"></option>
                  <option value="1600*900"></option>
                  <option value="1366*768"></option>
                  <option value="1280*720"></option>
                  <option value="800*600"></option>
                  <option value="640*480"></option>
                </datalist>
              </div>
              <div class="item common-input">
                <span>æ¸²æŸ“å¸§ç‡</span>
                <input type="number" name="pixelStreamingWebRTCFps" id="pixelStreamingWebRTCFps"
                  placeholder="å¡«å…¥æ‰€éœ€æ¸²æŸ“å‡ºçš„å¸§ç‡(åº”ä¸ºæ•°å­—)" />
              </div>
              <div class="item common-input">
                <span>GPUæ•°é‡</span>
                <input type="number" name="GPUNumber" id="GPUNumber"
                  placeholder="è¯·å¡«å…¥éœ€è¦çš„GPUæ•°é‡"/>
              </div>
              <div class="item switch-input">
                <span>å¿½ç•¥é”™è¯¯å¼¹çª—</span>
                <input type="checkbox" name="unattended" id="unattended" checked />
              </div>
              <div class="item switch-input">
                <span>åå°æ¸²æŸ“UE</span>
                <input type="checkbox" name="renderOffScreen" id="renderOffScreen" checked />
              </div>
              <div class="item switch-input">
                <span>ä¼ è¾“éŸ³é¢‘</span>
                <input type="checkbox" name="audioMixer" />
              </div>
            </div>
          </div>
          <div class="textarea-container">
            <span>iceServers</span>
            <textarea id="iceServers" name="iceServers"></textarea>
          </div>
          <div class="textarea-container">
            <span>å¤‡æ³¨</span>
            <textarea id="comment" name="comment"></textarea>
          </div>
        </form> 
      `;
    const runningServer = `
        <div id="runningServers-container">
            <video is="peer-stream" id="ws://10.0.42.16:88" audio> </video>

          <!-- WebRTC monitor -->
          <pre id="stats">Not connected</pre>    
        </div>
      `;
    // DOMæŸ¥è¯¢ç¼“å­˜
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const handleRebootWindow = async () => {
      try {
        await fetch("./rebootWindow");
      } catch (error) {
        console.log("rebootWindow failed", error);
      }
    };

    $("rebootWindow").addEventListener("click", handleRebootWindow);

    const highlightActiveLink = (hash) => {
      // ç§»é™¤æ‰€æœ‰é«˜äº®
      $$('[name^="linkTo"]').forEach((element) => {
        element.classList.remove("highlighted");
      });
      // æ ¹æ®å“ˆå¸Œå€¼é«˜äº®ç›¸åº”çš„é“¾æ¥
      switch (hash) {
        case "/updateConfig":
          $("[name = linkToConfig]").classList.add("highlighted");
          break;
        default:
          $("[name = linkToServer]").classList.add("highlighted");
      }
    };
    //æ¸²æŸ“é¡µé¢ä¸»å†…å®¹
    const renderPageContent = async (pageHash) => {
      const rv = document.querySelector(".router-view");
      switch (pageHash) {
        case "/updateConfig": {
          rv.innerHTML = updateConfig;
          await renderConfigForm();
          $("#auth").addEventListener("focus", () => toggleAuthInfo(event));
          $("#auth").addEventListener("blur", () => toggleAuthInfo(event));
          $("#http-auth").addEventListener("click", () => toggleAuthInput());
          $("#configForm").addEventListener("change", () =>
            submitConfig(event)
          );
          if (typeof ps !== "undefined") window.clearTimeout(ps.timeout);
          break;
        }
        default: {
          rv.innerHTML = runningServer;
          ps.addEventListener("playing", aggregateStats, {
            once: true,
          });
          ps.addEventListener("message", (e) => { });
          ps.addEventListener("suspend", (e) => { });
          ps.addEventListener("playerdisconnected", (e) => {
            console.log("playerdisconnected");
          });
        }
      }
    };

    //å¼€å…³httpéªŒè¯
    const toggleAuthInput = () => {
      const displayAuth = $("#http-auth").checked;
      $(".auth-input").style.display = displayAuth ? "flex" : "none";
      $(".auth-input").querySelector("input").value = "";
    };
    const toggleAuthInfo = (event) => {
      const auth = $("#auth");
      switch (event.type) {
        case "focus":
          auth.type = "text";
          break;
        case "blur":
          auth.type = "password";
          break;
      }
    };
    const parseUE5 = (UE5) => {
      const exec = {
        unattended: false,
        renderOffScreen: false,
        audioMixer: false,
      };

      const params = UE5.split(" ");
      [, exec.GPUFile] = params;

      const paramMapping = {
        "-PixelStreamingURL": "pixelStreamingURL",
        "-GraphicsAdapter": "graphicsAdapter",
        "-ResX": "resX",
        "-ResY": "resY",
        "-PixelStreamingWebRTCFps": "pixelStreamingWebRTCFps",
        "-Unattended": "unattended",
        "-RenderOffScreen": "renderOffScreen",
        "-AudioMixer": "audioMixer",
      };

      params.forEach((param) => {
        if (param.startsWith("-")) {
          const [key, value] = param.split("=");
          if (paramMapping[key]) {
            exec[paramMapping[key]] =
              key.startsWith("-Unattended") ||
                key.startsWith("-RenderOffScreen") ||
                key.startsWith("-AudioMixer")
                ? true
                : value;
          }
        }
      });

      exec.resolution = `${exec.resX}*${exec.resY}`;
      delete exec.resX;
      delete exec.resY;

      return exec;
    };

    const processData = (data) => {
      const params = [
        "PORT",
        "auth",
        "one2one",
        "UE5",
        "preload",
        "exeUeCoolTime",
        "UEVersion",
        "iceServers",
        "boot",
        "comment",
      ];
      const handlers = {
        UE5: (value) => {
          const shareInfo = ({
            GPUFile,
            pixelStreamingURL,
            graphicsAdapter,
            resolution,
            pixelStreamingWebRTCFps,
            unattended,
            renderOffScreen,
            audioMixer,
          } = parseUE5(value[0]));
          shareInfo.graphicsAdapter = new Map();
          value.forEach((exec) => {
            const { graphicsAdapter } = parseUE5(exec);
            shareInfo.graphicsAdapter.set(
              graphicsAdapter,
              (shareInfo.graphicsAdapter.get(graphicsAdapter) || 0) + 1
            );
          });
          shareInfo.GPUNumber = shareInfo.graphicsAdapter.size;
          for (const item in shareInfo) {
            if (item === "graphicsAdapter") {
              for (const gpuInfo of shareInfo.graphicsAdapter) {
                const temp = execTemp({
                  graphicsAdapter: gpuInfo[0],
                  GPUNumber: gpuInfo[1],
                });
                const exec = str2dom(temp).querySelector(".exec");

                $("#exec-input").appendChild(exec);
              }
            } else {
              const input = $(`[name = ${item}]`);
              if (input.type === "checkbox") {
                input.checked = shareInfo[`${item}`];
              } else {
                input.value = shareInfo[`${item}`];
              }
            }
          }
        },

        iceServers: (value) => {
          $("[name=iceServers]").value = JSON.stringify(value, null, "\t");
        },
        auth: (value) => {
          if (typeof value === "string") {
            $("#auth").value = value;
            $("#http-auth").checked = true;
          } else if (typeof value === "boolean") {
            $("#http-auth").checked = value;
            toggleAuthInput();
          }
        },
        UEVersion: (value) => {
          document.querySelector("[name=UEVersion]").checked = value === 4.27;
        },
      };

      for (const key in data) {
        if (!params.includes(key)) continue;

        if (handlers[key]) {
          handlers[key](data[key]);
        } else {
          const item = document.querySelector(`[name="${key}"]`);
          if (item) {
            if (item.type === "checkbox") {
              item.checked = data[key];
            } else {
              item.value = data[key];
            }
          }
        }
      }
    };

    const renderConfigForm = () => {
      return fetch("./signal.json")
        .then((res) => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then((data) => {
          processData(data);
        })
        .catch((error) => {
          alert("è·å–signal.jsonå¤±è´¥ï¼ï¼ï¼");
          console.log("fetch signal.json failed ", error);
        });
    };

    //å¤„ç†è·å–åˆ°çš„é…ç½®å¹¶æäº¤
    const submitConfig = async (event) => {
      try {
        const config = {};
        const element = event.target;
        console.log(element.parentNode.parentNode);
        const key = element.id;
        let value =
          element.type === "checkbox" ? element.checked : element.value;
        let PORT_new = null;

        if (key === "GPUNumber") {
          var execElements = $$(".exec");
          var gpuNumber = parseInt($("#GPUNumber").value, 10);

          if (execElements.length < gpuNumber) {
            for (let i = execElements.length; i < gpuNumber; i++) {
              const temp = execTemp({
                graphicsAdapter: i,
                GPUNumber: 0,
              });
              const exec = str2dom(temp).querySelector(".exec");

              $("#exec-input").appendChild(exec);
            }
          } else if (execElements.length > gpuNumber) {
            var excess = execElements.length - gpuNumber;

            for (let i = 0; i < excess; i++) {
              execElements[execElements.length - 1 - i].remove();
            }
          }
          return;
        }
        if (key === "http-auth" && value === true) return;
        if (key === "iceServers" && !canBeParsed(value)) {
          alert("iceServersæ ¼å¼æœ‰è¯¯ï¼");
          renderPageContent(window.location.hash.slice(1));
          return;
        }
        if ($("#exec-input").contains(element)) {
          config["UE5"] = [];
          const selector = (name) => $(`[name=${name}]`);

          const GPUFile = selector("GPUFile").value;
          const pixelStreamingURL = selector("pixelStreamingURL").value;
          const [resX, resY] = selector("resolution").value.split("*");
          const pixelStreamingWebRTCFps = selector(
            "pixelStreamingWebRTCFps"
          ).value;

          const unattended = selector("unattended").checked ? "-Unattended" : "";
          const renderOffScreen = selector("renderOffScreen").checked
            ? "-RenderOffScreen"
            : "";
          const audioMixer = selector("audioMixer").checked ? "-AudioMixer" : "";

          $$("[name = processNumber]").forEach(exec => {
            const processNumber = exec.value;
            for (let i = 0; i < processNumber; i++) {
              config["UE5"].push(`start ${GPUFile} ${unattended} ${renderOffScreen} ${audioMixer} -PixelStreamingURL=${pixelStreamingURL} -GraphicsAdapter=${exec.id} -ForceRes -ResX=${resX} -ResY=${resY} -PixelStreamingWebRTCFps=${pixelStreamingWebRTCFps}`)
            }
          })
        } else {
          switch (element.type) {
            case "number":
              config[key] = parseFloat(value);
              if (key === "PORT" && value !== window.location.port)
                PORT_new = value;
              break;
            case "checkbox":
              config[key === "http-auth" ? "auth" : key] =
                key === "UEVersion" ? (value ? 4.27 : 5) : value;
              break;
            default:
              if (element.name === "auth") {
                const authRule = /^[a-zA-Z0-9]+:[a-zA-Z0-9]+$/;
                if (!authRule.test(value)) {
                  alert(
                    "è¯·è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç æ ¼å¼ï¼Œä¾‹å¦‚ï¼šusername:passwordã€‚"
                  );
                  renderPageContent(window.location.hash.slice(1));
                  return;
                }
              }
              config[key] =
                element.name === "iceServers" ? JSON.parse(value) : value;
          }
        }

        await fetch("./signal", {
          method: "POST",
          headers: {
            "Content-type": "application/json",
            "signal": encodeURIComponent(JSON.stringify(config))
          },
        }).then((res) => {
          if (res.ok) {
            $("[name = linkToConfig]").setAttribute(
              "data-normal",
              "âœ… æ›´æ–°æˆåŠŸ"
            );
            $("[name = linkToConfig]").setAttribute("data-mini", "âœ…");
            $("[name = linkToConfig]").animate(
              [{ opacity: 0 }, { opacity: 1 }],
              {
                duration: 200,
                iterations: 3,
                easing: "steps(2, jump-none)",
              }
            );
            setTimeout(() => {
              $("[name = linkToConfig]").setAttribute(
                "data-normal",
                "âš™ï¸ signal.json"
              );
              $("[name = linkToConfig]").setAttribute("data-mini", "âš™ï¸");
            }, 1000);

            if (PORT_new) {
              const url = new URL(window.location);
              url.port = PORT_new;
              window.location.replace(url);
            }
          } else {
            alert(`âŒ æ›´æ–°å¤±è´¥ ${res.statusText}`);
            renderPageContent(window.location.hash.slice(1));
          }
        });
      } catch (error) {
        alert(`âŒ æ›´æ–°å¤±è´¥ ${error}`);
        console.log("updateConfig failed", error);
      }
    };

    const aggregateStats = async () => {
      const statsReport = await ps.pc.getStats(null);
      stats.innerText = "";

      // most < 27
      if (ps.VideoEncoderQP < 27) {
        stats.style.color = "lime";
      } else if (ps.VideoEncoderQP < 36) {
        stats.style.color = "orange";
        stats.innerText += `\n Spotty Network !`;
      } else {
        stats.style.color = "red";
        stats.innerText += `\n Bad Network !!`;
      }

      stats.innerText += `\n Video Quantization Parameter: ${ps.VideoEncoderQP}`;
      statsReport.forEach((stat) => {
        switch (stat.type) {
          case "data-channel": {
            stats.innerText += `\n âœ‰ Data Channel â†‘â†‘ ${stat.bytesSent.toLocaleString()} B`;
            stats.innerText += `\n âœ‰ Data Channel â†“â†“ ${stat.bytesReceived.toLocaleString()} B`;
            break;
          }
          case "inbound-rtp": {
            if (stat.mediaType === "video")
              stats.innerText += [
                ``,
                `	Size: ${stat.frameWidth} x ${stat.frameHeight}`,
                `	Frames Decoded: ${stat.framesDecoded.toLocaleString()}`,
                `	Packets Lost: ${stat.packetsLost.toLocaleString()}`,
                `	FPS: ${stat.framesPerSecond} Hz`,
                `	Frames Dropped: ${stat.framesDropped}`,
                `	Video â†“â†“ ${stat.bytesReceived.toLocaleString()} B`,
              ].join("\n");
            else if (stat.mediaType === "audio")
              stats.innerText += `\n â™¬ Audio â†“â†“ ${stat.bytesReceived.toLocaleString()} B`;
            break;
          }
          case "candidate-pair": {
            if (stat.state === "succeeded")
              stats.innerText += `\n Latency(RTT): ${stat.currentRoundTripTime} s`;
            break;
          }
          case "remote-candidate": {
            stats.innerText +=
              `\n ` + stat.protocol + ":// " + stat.ip + ": " + stat.port;
            break;
          }
          case "transport": {
            const bitrate = ~~(
              ((stat.bytesReceived - this.bytesReceived) /
                (stat.timestamp - this.timestamp)) *
              (1000 * 8)
            );

            stats.innerText += `\n â‡Œ Bitrate: ${bitrate.toLocaleString()} bps`;

            this.bytesReceived = stat.bytesReceived;
            this.timestamp = stat.timestamp;
            break;
          }
          default: {
          }
        }
      });

      stats.innerText += `\n â² Current Time: ${ps.currentTime} s`;

      ps.timeout = setTimeout(aggregateStats, 1000);
    };

    const navigateBasedOnHash = () => {
      const pageHash = window.location.hash.slice(1);
      renderPageContent(pageHash);
      highlightActiveLink(pageHash);
    };
    // // é¡µé¢åŠ è½½å’Œå˜åŒ–äº‹ä»¶
    window.onload = () => {
      navigateBasedOnHash();
    };
    window.onhashchange = () => {
      navigateBasedOnHash();
    };
  </script>
</body>

</html>